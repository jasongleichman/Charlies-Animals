<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Charlie's Animal Words</title>

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Animal Words" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/lucide@0.453.0/dist/umd/lucide.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
    }
  </script>

  <style>
    html, body, #root { height: 100%; margin:0; padding:0; overflow:hidden; background:#f8fafc; }
    .safe { padding-top: env(safe-area-inset-top); padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right); padding-bottom: env(safe-area-inset-bottom); }
  </style>
</head>
<body class="safe">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const LucideIcon = ({ name, className="" }) => {
      React.useEffect(() => { window.lucide?.createIcons?.(); });
      return <i data-lucide={name} className={className} />;
    };
    const Play=(p)=><LucideIcon name="play" {...p}/>; const Award=(p)=><LucideIcon name="award"{...p}/>;
    const Home=(p)=><LucideIcon name="home"{...p}/>; const Volume2=(p)=><LucideIcon name="volume-2"{...p}/>;
    const CheckCircle=(p)=><LucideIcon name="check-circle"{...p}/>; const Database=(p)=><LucideIcon name="database"{...p}/>;
    const ChevronRight=(p)=><LucideIcon name="chevron-right"{...p}/>;

    const getSavedName = () => { try { return localStorage.getItem('playerName') || ''; } catch { return ''; } };
    const saveName = (name) => { try { localStorage.setItem('playerName', name); } catch {} };

    const TTS = {
      _picked:null,
      pick(){
        const ss = window.speechSynthesis; if(!ss) return null;
        const pref = ['Alex','Fred','Daniel','Matthew','Google US English','US English Male'];
        const voices = ss.getVoices();
        for (const n of pref){ const v=voices.find(v=>v.name.includes(n)); if(v) return v; }
        const en = voices.filter(v => /^en[-_]/i.test(v.lang)); return en[0] || voices[0] || null;
      },
      speak(text){ const ss=window.speechSynthesis; if(!ss) return;
        if(!this._picked){ this._picked=this.pick(); if(!this._picked){ ss.onvoiceschanged=()=>{this._picked=this.pick(); this.speak(text);} ; return; } }
        const u=new SpeechSynthesisUtterance(text); u.voice=this._picked; u.rate=0.95; u.pitch=0.9; u.lang='en-US';
        ss.cancel(); ss.speak(u);
      }
    };
    const speakNow = (text) => TTS.speak(text);

    const ANIMALS = [
      { name:"Fennec Fox", img:"https://images.unsplash.com/photo-1543852786-1cf6624b9987?q=80&w=800&auto=format&fit=crop" },
      { name:"Axolotl", img:"https://images.unsplash.com/photo-1591267990531-7a0f54818651?q=80&w=800&auto=format&fit=crop" },
      { name:"Goblin Shark", img:"https://images.unsplash.com/photo-1527606434330-47fc38024cfd?q=80&w=800&auto=format&fit=crop" }
    ];

    async function precacheUrls(urls){
      if (!navigator.serviceWorker) return;
      if (!navigator.serviceWorker.controller) {
        await new Promise(res => {
          const to=setTimeout(res,1200);
          navigator.serviceWorker.addEventListener('controllerchange', ()=>{ clearTimeout(to); res(); }, { once:true });
        });
      }
      navigator.serviceWorker.controller?.postMessage({ type:'PRECACHE', urls });
    }

    const ProfileSetupScreen = ({ userName, setUserName, onStart }) => (
      <div className="h-full flex items-center justify-center bg-emerald-50 p-4">
        <form onSubmit={(e)=>{e.preventDefault(); onStart();}} className="bg-white p-6 rounded-3xl shadow max-w-md w-full space-y-4">
          <div className="flex items-center gap-3"><Award className="w-8 h-8 text-emerald-600" /><h1 className="text-2xl font-bold">Welcome!</h1></div>
          <p className="text-gray-600">Enter your name to track your progress and collection.</p>
          <input className="w-full border rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-emerald-400"
                 placeholder="Your name" value={userName} onChange={e=>setUserName(e.target.value)} autoFocus />
          <!-- Force-enable button; guard empty name in handler -->
          <button type="submit"
            className="w-full flex items-center justify-center gap-2 rounded-xl px-4 py-3 font-semibold transition bg-emerald-500 hover:bg-emerald-600 text-white">
            <Play className="w-5 h-5" /> {getSavedName() ? "Continue" : "Start Playing"}
          </button>
        </form>
      </div>
    );

    const WelcomeScreen = ({ onPlay }) => (
      <div className="h-full flex items-center justify-center bg-emerald-50 p-4">
        <div className="bg-white p-6 rounded-3xl shadow max-w-md w-full text-center space-y-4">
          <Home className="w-12 h-12 text-emerald-600 mx-auto" />
          <h1 className="text-3xl font-bold text-gray-800">Animal Words</h1>
          <button onClick={()=>speakNow('Animal Words')} className="bg-emerald-100 px-4 py-2 rounded-xl flex items-center justify-center gap-2 mx-auto">
            <Volume2 className="w-5 h-5" /> Say Title
          </button>
          <button onClick={onPlay} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 rounded-xl transition flex items-center justify-center gap-2">
            <Play className="w-5 h-5" /> Start Game
          </button>
        </div>
      </div>
    );

    const GameScreen = ({ onFinish }) => {
      const [i,setI]=useState(0); const a=ANIMALS[i];
      return (
        <div className="h-full flex items-center justify-center bg-white p-4">
          <div className="max-w-xl w-full text-center space-y-4">
            <img src={a.img} alt={a.name} className="w-full aspect-video object-cover rounded-2xl border" />
            <h2 className="text-2xl font-bold text-gray-800">{a.name}</h2>
            <div className="flex items-center justify-center gap-3">
              <button onClick={()=>speakNow(a.name)} className="px-4 py-2 rounded-xl bg-emerald-100 hover:bg-emerald-200 text-emerald-700 flex items-center gap-2">
                <Volume2 className="w-5 h-5" /> Pronounce
              </button>
              <button onClick={()=>setI((i+1)%ANIMALS.length)} className="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-700 flex items-center gap-2">
                Next <ChevronRight className="w-5 h-5" />
              </button>
            </div>
            <button onClick={onFinish} className="mt-6 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-semibold transition">Finish</button>
          </div>
        </div>
      );
    };

    const Database = (p)=> <LucideIcon name="database" {...p}/>; // alias

    const CachingScreen = ({ onDone }) => {
      const [p,setP]=useState(0);
      useEffect(()=>{
        const urls = ANIMALS.map(a=>a.img);
        precacheUrls(urls);
        let i=0; const t=setInterval(()=>{ i+=12; setP(Math.min(i,100)); if(i>=100){ clearInterval(t); onDone();}},120);
        return ()=>clearInterval(t);
      },[]);
      return (
        <div className="h-full flex items-center justify-center bg-emerald-50 p-4">
          <div className="bg-white rounded-3xl border shadow p-8 w-full max-w-md text-center">
            <Database className="w-14 h-14 text-emerald-600 mx-auto mb-3 animate-pulse" />
            <h3 className="text-2xl font-bold text-gray-800 mb-1">Optimizing App Experience</h3>
            <p className="text-gray-600 text-sm mb-6">Caching images and warming up voice.</p>
            <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden"><div className="h-full bg-emerald-500 transition-all" style={{width:p+'%'}}/></div>
            <p className="mt-2 text-sm text-gray-700 font-medium">{p}% Complete</p>
          </div>
        </div>
      );
    };

    function App(){
      const [view,setView]=useState('setup');
      const [userName,setUserName]=useState(getSavedName());

      const onStart = () => {
        const name = (userName || '').trim();
        if (!name) { alert('Please enter your name'); return; }
        saveName(name);
        setView('caching'); // go directly to caching/welcome flow even without Firebase
      };

      switch(view){
        case 'setup': return <ProfileSetupScreen userName={userName} setUserName={setUserName} onStart={onStart} />;
        case 'caching': return <CachingScreen onDone={()=>setView('welcome')} />;
        case 'welcome': return <WelcomeScreen onPlay={()=>setView('game')} />;
        case 'game': return <GameScreen onFinish={()=>setView('welcome')} />;
        default: return <div className="p-6">Loadingâ€¦</div>;
      }
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
